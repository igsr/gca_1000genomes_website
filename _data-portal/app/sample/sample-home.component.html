<h1>Samples</h1>
<div class="form form-inline">
<button class="btn btn-default" (click)="dataCollectionView()"><span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span> Data collection view</button>
<button class="btn btn-default" (click)="technologyView()"><span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span> Technology view</button>
</div>
<br>
<div class="form form-inline">
<button class="btn btn-default" (click)="popFilterVisible = !popFilterVisible; agFilterVisible = false; dcFilterVisible = false;">Filter by population <span class="caret"></span></button>
<button class="btn btn-default" (click)="agFilterVisible = !agFilterVisible; popFilterVisible = false; dcFilterVisible = false;">Filter by technology <span class="caret"></span></button>
<button class="btn btn-default" (click)="dcFilterVisible = !dcFilterVisible; popFilterVisible = false; agFilterVisible = false;">Filter by data collection <span class="caret"></span></button>
<button class="btn btn-default" (click)="searchExport()"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> Download the list</button>
</div>

<div class="row">
  <div class="col-md-8 col-md-offset-2">
    <population-filter [(visible)]="popFilterVisible" [filters]="popFilters" (filtersChange)="onPopFiltersChange($event)"></population-filter>
    <analysis-group-filter [(visible)]="agFilterVisible" [filters]="agFilters" (filtersChange)="onAgFiltersChange($event)"></analysis-group-filter>
    <data-collection-filter [(visible)]="dcFilterVisible" [filters]="dcFilters" (filtersChange)="onDcFiltersChange($event)"></data-collection-filter>
  </div>
</div>


<div class="row">
  <div class="col-md-10 col-md-offset-1" *ngIf="filterTokens.length">
    <div class="panel panel-default filter-builder-panel">
      <div class="panel-heading">
        <h3 class="panel-title">Build filtration query</h3>
      </div>
      <div class="panel-body">
        <div class="filter-builder-help">
          <p>Build a custom filter query in 3 steps:</p>
          <ol class="filter-builder-steps">
            <li>
              <strong>Add filters</strong>
              Use the drop-downs to add filter chips in the order you want.
            </li>
            <li>
              <strong>Edit query logic</strong>
              Click a chip to select or deselect it.
              <br>Use Group/Ungroup to add or remove parentheses around selected adjacent chips.
              <br>Use NOT to exclude selected chips.
              <br>Click AND/OR between chips to change the operator.
            </li>
            <li>
              <strong>Remove filters</strong>
              Click <code>x</code> on a chip to remove it.
            </li>
          </ol>
        </div>
        <div class="tools-row">
          <h3 class="current-filters section-indicator">Tools</h3>
          <span class="group-controls">
            <button class="btn btn-default btn-xs group-control-btn" [ngClass]="{disabled: !canGroupSelection()}" [disabled]="!canGroupSelection()" (click)="groupSelection()"
              [popover]="'Select contiguous chips, then click here to group them'" [popoverOnHover]="true" popoverPlacement="auto top">Group</button>
            <button class="btn btn-default btn-xs group-control-btn" [ngClass]="{disabled: !canUngroupSelection()}" [disabled]="!canUngroupSelection()" (click)="ungroupSelection()"
              [popover]="'Select chips inside a group, then click here to ungroup them'" [popoverOnHover]="true" popoverPlacement="auto top">Ungroup</button>
            <button class="btn btn-default btn-xs group-control-btn" [ngClass]="{disabled: !canNegateSelection()}" [disabled]="!canNegateSelection()" (click)="toggleNegationForSelection()"
              [popover]="'Select chip(s), then click here to negate them'" [popoverOnHover]="true" popoverPlacement="auto top">NOT</button>
          </span>
        </div>
        <h3 class="current-filters section-indicator">Filters</h3>
        <ng-container *ngFor="let token of filterTokens; let i = index">
          <ng-container *ngFor="let _ of parenRange(groupStartCount(token))">
            <span class="group-paren">(</span>
          </ng-container>
          <button class="btn"
            [ngClass]="{'btn-primary': token.type === 'pop', 'btn-warning': token.type === 'dc', 'btn-info': token.type === 'ag'}"
            [class.filter-negated]="token.negated"
            [class.filter-selected]="isTokenSelected(token)"
            (click)="toggleTokenSelected(token)"
            [popover]="'Click chip body to select, click again to deselect, click x to remove'" [popoverOnHover]="true" popoverPlacement="auto top">
            <span class="chip-negation-flag" *ngIf="token.negated">NOT</span>
            <ng-container [ngSwitch]="token.type">
              <ng-container *ngSwitchCase="'pop'">{{token.key | i18nSelect: popElasticIdDescriptionMap}}</ng-container>
              <ng-container *ngSwitchCase="'dc'">{{token.key | i18nSelect: dcTitleMap}}</ng-container>
              <ng-container *ngSwitchCase="'ag'">{{token.key | i18nSelect: agTitleMap}}</ng-container>
            </ng-container>
            <span class="glyphicon glyphicon-remove" aria-hidden="true" (click)="removeTokenFromFilters(token); $event.stopPropagation()"></span>
          </button>
          <ng-container *ngFor="let _ of parenRange(groupEndCount(token))">
            <span class="group-paren">)</span>
          </ng-container>
          <button *ngIf="i < filterOperators.length" class="btn btn-default operator-chip" (click)="toggleChainOperator(i)"
            [popover]="'Click to toggle operator between AND/OR'" [popoverOnHover]="true" popoverPlacement="auto top">
            {{filterOperators[i]}}
          </button>
        </ng-container>
        <div class="query-description-block" *ngIf="readableFilterSummary">
          <h3 class="current-filters section-indicator">Summary</h3>
          <p class="readable-filter-summary" [innerHTML]="readableFilterSummary"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="table-container">
<div class="table-buttons">
  <h4 *ngIf="totalHits > 0">Showing {{displayStart}} to {{displayStop}} of {{totalHits}} samples</h4>
  <h4 *ngIf="totalHits == 0">No samples match filters</h4>
  <button class="btn btn-default page-button pull-left" [ngClass]="{disabled: offset <=0}" (click)="tablePrevious()">&#171; Previous</button>
  <button class="btn btn-default page-button pull-left" [ngClass]="{disabled: !hasMore()}" (click)="tableNext()">Next &#187;</button>
</div>
<sample-data-collection-table *ngIf="viewOption == 1" [sampleHits]="sampleHits" [filters]="dcFilters" (filtersChange)="onDcFiltersChange($event)"></sample-data-collection-table>
<sample-analysis-group-table *ngIf="viewOption == 2" [sampleHits]="sampleHits" [filters]="agFilters" (filtersChange)="onAgFiltersChange($event)"></sample-analysis-group-table>
</div>
<button class="btn btn-default page-button pull-left" [ngClass]="{disabled: offset <=0}" (click)="tablePrevious()">&#171; Previous</button>
<button class="btn btn-default page-button pull-right" [ngClass]="{disabled: !hasMore()}" (click)="tableNext()">Next &#187;</button>
